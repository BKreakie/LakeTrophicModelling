---
title: 'Modeling Lake Trophic State: A Data Mining Approach'
author: 
- name: Jeffrey W. Hollister
  affilnum: 1
  email: hollister.jeff@epa.gov
- name: W. Bryan Milstead
  affilnum: 1
- name: Betty J. Kreakie
  affilnum: 1
affiliation:
- affilnum: 1
  affil: US Environmental Protection Agency, Office of Research and Development, National     Health and Environmental Effects Research Laboratory, Atlantic Ecology Division, 27 Tarzwell Drive  Narragansett, RI, 02882, USA
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    template: components/manuscript.latex
fontsize: 11pt
capsize: normalsize
csl: components/ecology.csl
documentclass: article
spacing: doublespacing
linenumbers: yes
bibliography: components/LakeTrophicModelling.bib
abstract: no
---

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Modeling Lake Trophic State: A Data Mining Approach}
-->

```{r setup, include=FALSE, echo=FALSE}
#devtools::install_github("USEPA/LakeTrophicModelling",quick=TRUE,
#                        auth_token="8742a8c1c2207393659a1de1bd53527fa56ea0d7")
devtools::install_github("jhollist/wesanderson")
devtools::install_github("jhollist/condprob2")
library("wesanderson")
library("LakeTrophicModelling")
library("knitr")
library("ggplot2")
library("sp")
library("rgdal")
library("e1071")
library("dplyr")
library("tidyr")
library("condprob2")
opts_chunk$set(dev = 'pdf', fig.width=7.5)
data(LakeTrophicModelling)


#Checks for existing cache (from another project)
if(file.exists("prior_cache")){
  for(i in gsub(".rdb","",list.files("prior_cache",".rdb",full.names=T))){
    lazyLoad(i)
  }
}


# Table Captions from @DeanK on 
#http://stackoverflow.com/questions/15258233/using-table-caption-on-r-markdown-file-using-knitr-to-use-in-pandoc-to-convert-t

knit_hooks$set(tab.cap = function(before, options, envir) {
                  if(!before) { 
                    paste('\n\n:', options$tab.cap, sep='') 
                  }
                })
default_output_hook = knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  if (is.null(options$tab.cap) == FALSE) {
    x
  } else
    default_output_hook(x,options)
})
```

```{r analysis , eval=TRUE, include=FALSE, echo=FALSE, cache=TRUE}
################################################################################
#All analysis in here, that way all bits of paper have access to final objects
#Tables, figures, and numerical results placed at end of paper.
#Included for completeness.  Results already run in another project
#Those results loaded via lazyLoad in setup chunk
#This chunk takes several days to complete - DO NOT EDIT!!!
################################################################################
#Model 1: All Variables, 4 Trophic State Classes
  #Variable Selction
  #all_ts4<-iterVarSelRF(ltmData[predictors_all],ltmData$TS_CHLA_4,numCore=4,100,
  #      								ntree=10000,ntreeIterat=5000,vars.drop.frac=NULL,
  #  											vars.drop.num=1,outStr="all_ts4",time=TRUE)
  #all_ts4_rf_full<-runRandomForest(ltmData[predictors_all],ltmData$TS_CHLA_4, 
  #                          ntree=10000,importance=TRUE,proximity=TRUE)
  #Random Forest
  all_ts4_vars<-unique(unlist(all_ts4[1:100]))
  all_ts4_rf<-runRandomForest(ltmData[all_ts4_vars],ltmData$TS_CHLA_4, 
                              ntree=10000,importance=TRUE,proximity=TRUE)
################################################################################
#Model 2: All Variables, 3 Trophic State Classes
  #Variable Selction
  #all_ts3<-iterVarSelRF(ltmData[predictors_all],ltmData$TS_CHLA_3,numCore=4,100,
  #    									ntree=10000,ntreeIterat=5000,vars.drop.frac=NULL,
  #  											vars.drop.num=1,outStr="all_ts3",time=TRUE)
  # all_ts3_rf_full<-runRandomForest(ltmData[predictors_all],ltmData$TS_CHLA_3, 
  #                            ntree=10000,importance=TRUE,proximity=TRUE)
  #Random Forest
  all_ts3_vars<-unique(unlist(all_ts3[1:100]))
  all_ts3_rf<-runRandomForest(ltmData[all_ts3_vars],ltmData$TS_CHLA_3, 
                              ntree=10000,importance=TRUE,proximity=TRUE)
################################################################################
#Model 3: All Variables, 2 Trophic State Classes
  #Variable Selction
  #all_ts2<-iterVarSelRF(ltmData[predictors_all],ltmData$TS_CHLA_2,numCore=4,100,
  #    									ntree=10000,ntreeIterat=5000,vars.drop.frac=NULL,
  #											vars.drop.num=1,outStr="all_ts2",time=TRUE)
  #all_ts2_rf_full<-runRandomForest(ltmData[predictors_all],ltmData$TS_CHLA_2, 
  #                           ntree=10000,importance=TRUE,proximity=TRUE)
  #Random Forest
  all_ts2_vars<-unique(unlist(all_ts2[1:100]))
  all_ts2_rf<-runRandomForest(ltmData[all_ts2_vars],ltmData$TS_CHLA_2, 
                              ntree=10000,importance=TRUE,proximity=TRUE)
################################################################################
#Model 4: GIS Only Variables, 4 Trophic State Classes
  #Variable Selction
  #gis_ts4<-iterVarSelRF(ltmData[predictors_gis],ltmData$TS_CHLA_4,numCore=4,100,
  #        							ntree=10000,ntreeIterat=5000,vars.drop.frac=NULL,
  #											vars.drop.num=1,outStr="gis_ts4",time=TRUE)
  #gis_ts4_rf_full<-runRandomForest(ltmData[predictors_gis],ltmData$TS_CHLA_4, 
  #                            ntree=10000,importance=TRUE,proximity=TRUE)
  #Random Forest
  gis_ts4_vars<-unique(unlist(gis_ts4[1:100]))
  gis_ts4_rf<-runRandomForest(ltmData[gis_ts4_vars],ltmData$TS_CHLA_4, 
                              ntree=10000,importance=TRUE,proximity=TRUE)
################################################################################
#Model 5: GIS Only Variables, 3 Trophic State Classes
  #Variable Selction
  #gis_ts3<-iterVarSelRF(ltmData[predictors_gis],ltmData$TS_CHLA_3,numCore=4,100,
  #      								ntree=10000,ntreeIterat=5000,vars.drop.frac=NULL,
  #											vars.drop.num=1,outStr="gis_ts3",time=TRUE)
  #gis_ts3_rf_full<-runRandomForest(ltmData[predictors_gis],ltmData$TS_CHLA_3, 
  #                            ntree=10000,importance=TRUE,proximity=TRUE)
  #Random Forest
  gis_ts3_vars<-unique(unlist(gis_ts3[1:100]))
  gis_ts3_rf<-runRandomForest(ltmData[gis_ts3_vars],ltmData$TS_CHLA_3, 
                              ntree=10000,importance=TRUE,proximity=TRUE)
################################################################################
#Model 6: GIS Only Variables, 2 Trophic State Classes
  #Variable Selction
  #gis_ts2<-iterVarSelRF(ltmData[predictors_gis],ltmData$TS_CHLA_2,numCore=4,100,
  #    									ntree=10000,ntreeIterat=5000,vars.drop.frac=NULL,
  #											vars.drop.num=1,outStr="gis_ts2",time=TRUE)
  #gis_ts2_rf_full<-runRandomForest(ltmData[predictors_gis],ltmData$TS_CHLA_2, 
  #                            ntree=10000,importance=TRUE,proximity=TRUE)
  #Random Forest
  gis_ts2_vars<-unique(unlist(gis_ts2[1:100]))
  gis_ts2_rf<-runRandomForest(ltmData[gis_ts2_vars],ltmData$TS_CHLA_2, 
                              ntree=10000,importance=TRUE,proximity=TRUE)

```

```{r summaryStats, eval=TRUE, echo=FALSE, cache=FALSE, warning=FALSE}
acc_results<-data.frame(model_number=c("Model 1","Model 2","Model 3","Model 4","Model 5","Model 6"),
                        total_accuracy=c(classAgreement(all_ts4_rf$confusion[,1:4])$diag,
                                         classAgreement(all_ts3_rf$confusion[,1:3])$diag,
                                         classAgreement(all_ts2_rf$confusion[,1:2])$diag,
                                         classAgreement(gis_ts4_rf$confusion[,1:4])$diag,
                                         classAgreement(gis_ts3_rf$confusion[,1:3])$diag,
                                         classAgreement(gis_ts2_rf$confusion[,1:2])$diag),
                        kappa_coeff=c(classAgreement(all_ts4_rf$confusion[,1:4])$kappa,
                                         classAgreement(all_ts3_rf$confusion[,1:3])$kappa,
                                         classAgreement(all_ts2_rf$confusion[,1:2])$kappa,
                                         classAgreement(gis_ts4_rf$confusion[,1:4])$kappa,
                                         classAgreement(gis_ts3_rf$confusion[,1:3])$kappa,
                                         classAgreement(gis_ts2_rf$confusion[,1:2])$kappa))
var_importance<-rbind_list(varImportance(all_ts4_rf,"Model 1"),
                           varImportance(all_ts3_rf,"Model 2"),
                           varImportance(all_ts2_rf,"Model 3"),
                           varImportance(gis_ts4_rf,"Model 4"),
                           varImportance(gis_ts3_rf,"Model 5"),
                           varImportance(gis_ts2_rf,"Model 6"))
var_importance$variable_names<-factor(var_importance$variable_names)
#var_importance$model_id<-factor(var_importance$model_id)
var_importance<-inner_join(var_importance,data_def[c("variable_names","description")],"variable_names")
var_importance<-var_importance[order(var_importance$model_id,-var_importance$mean_decrease_gini, decreasing=FALSE),]                     

#Example Votes
lakeVotes<-data.frame(all_ts4_rf$y,all_ts4_rf$predicted,all_ts4_rf$votes)
lakeVotes<-data.frame(lakeVotes,max_prob=apply(lakeVotes[,3:6],1,max))
lakeVotes$all_ts4_rf.predicted<-factor(lakeVotes$all_ts4_rf.predicted,ordered=T)
lakeVotes<-data.frame(lakeVotes,correct_binary=lakeVotes$all_ts4_rf.y==lakeVotes$all_ts4_rf.predicted)
lakeVotes<-data.frame(COMID=getLakeIDs(ltmData[all_ts4_vars],ltmData$TS_CHLA_4,ltmData$Comid),lakeVotes)
lakeVotes<-na.omit(lakeVotes)
```


\singlespace

\vspace{2mm}\hrule

**Abstract**  
Productivity of lentic ecosystems has been well studied and it is widely accepted that as nutrient inputs increase,  productivity increases and lakes transition from low trophic state (e.g. oligotrophic) to higher trophic states  (e.g. eutrophic). These broad trophic state classifications are good predictors of ecosystem health and ecosystem services/disservices (e.g. recreation, aesthetics, fisheries, and harmful algal blooms). While the relationship between  nutrients and trophic state provides reliable predictions, it requires *in situ* water quality data in order to parameterize the model.  This limits the application of these models to lakes with existing and, more importantly, available water quality data.  To expand our ability to predict in lakes without water quality data, we take advantage of the availability of a large national lakes water quality database, land use/land cover data, lake morphometry data, other universally available data, and modern data mining approaches to build and assess models of lake tropic state that may be more universally applied.  We use random forests and random forest variable selection to identify variables to be used for predicting trophic state and we compare the performance of two models of trophic state (as determined by chlorophyll *a* concentration).   The first model estimates trophic state with *in situ* as well as universally available data and the second model uses universally available data only. For each of these models we used three separate trophic state categories, for a total of six models. Overall accuracy for models built from *in situ* and universal data ranged from `r round(min(acc_results[1:3,2]),3)`% to `r round(max(acc_results[1:3,2]),3)`%.  For the universal data only models, overall accuracy ranged from `r round(min(acc_results[4:6,2]),3)`% to `r round(max(acc_results[4:6,2]),3)`%. Lastly, it is believed that the presence and abundance of cyanobacteria is strongly associated with trophic state.  To test this we examine the association between estimates of cyanobacteria abundance and the measured and predicted trophic state and find a positive relationship.  Expanding these preliminary results to include cyanobacteria taxa indicates that cyanobacteria are significantly more likely to be found in highly eutrophic lakes. These results suggest that predictive models of lake trophic state may be improved with additional information on the landscape surrounding lakes and that those models provide additional information on the presence of potentially harmful cyanobacteria taxa. 

\vspace{3mm}\hrule
\doublespace

#Introduction
Productivity in lentic systems is often categorized across a range of tropic states (e.g. the tropic continuum) from early successional (i.e. oligotrophic)to late successional lakes (i.e. hypereutrophic) with lakes naturally occurring across this range [@carlson1977trophic]. Oligotrophic lakes occur in nutrient poor areas or have a more recent geologic history and are often found in higher elevations, have clear water, and are usually favored for drinking water or direct contact recreation (e.g. swimming).   Lakes with higher productivity (e.g. eutrophic lakes) have greater nutrient loads, tend to be less clear, have greater density of aquatic plants, and often support more diverse and abundant fish communities. Higher primary productivity is not necessarily a predictor of poor ecological condition as it is natural for lakes to shift from lower to higher trophic states but this is a slow process.  

Monitoring trophic state allows the identification of rapid shifts in trophic state or locating lakes with unusually high productivity (e.g. hypereutrophic).  These cases are indicative of lakes under greater anthropogenic nutrient loads, also known as cultural eutrophication, and are more likely to be at risk of fish kills, fouling, and harmful algal blooms [@smith1998cultural;@smith1999eutrophication;@smith2006eutrophication].  Given the association between trophic state and many ecosystem services and disservices, being able to accurately model trophic state could provide a first cut at identifying lakes with the potential for harmful algal blooms or other problems associated with cultural eutrophication. 

As trophic state and related indices can be best defined by a number of *in situ* water quality parameters (modeled or measured), most models have used this information as predictors [e.g., @carvalho_cyanobacterial_2011;@milstead2013estimating;@imboden1978dynamic;@salas1991simplified].  This leads to accurate models, but also requires data that is often sparse and not always available, thus limiting the population of lakes for which we can make predictions.  A possible solution for this is to build models that use widely available data that are correlated to many of the *in situ* variables. For instance, landscape metrics of forests, agriculture, wetlands, and urban land in contributing watersheds have all been shown to explain a significant proportion of the variation (ranging from 50-86%, depending on study) in nutrients in receiving waters [@jones2001predicting; @jones2004importance; @seilheimer2013landscape].  Building on these previously identified associations might allow us to use only landscape and other universally available data to build models.  Identifying predictors using this type of ubiquitous data would allow for estimating trophic state in both monitored and unmonitored lakes. 

Many published models of nutrients and trophic state in freshwater systems are based on linear modelling methods such as standard least squares methods or linear mixed models [e.g., @jones2004importance; @jones2001predicting].  While these methods have proven to be reliable, they are not without their limitations.  Using data mining approaches, such as random forests, avoids many of these limitations, may reduce bias and often provides better predictions [@cutler2007random; @peters2007random; @breiman2001random].  For instance, random forests are non-parametric and thus the data do not need to come from a specific distribution (e.g. Gaussian) and can contain collinear variables [@cutler2007random]. Second, random forests work well with very large numbers of predictors [@cutler2007random].  Lastly, random forests can deal with model selection uncertainty as predictions are based upon a consensus of many models and not just a single model selected with some measure of goodness of fit. 

To build on past work we have identified four goals for this research.  First, we update trophic state modelling efforts with the use of random forests.  Second, we assess the accuracy of predicted trophic state in lakes with the full suite of data and then with the universally available data only. Third, we identify important variables for describing lake trophic state and lastly, we explore associations between trophic state and cyanobacteria to begin to understand how changes in trophic state may be linked to an important ecosystem disservice.

#Methods

##Data and Study Area
We utilize four primary sources of data for this study,the National Lakes Assessment (NLA), the National Lake Cover Dataset (NLCD), modeled lake morphometery,  and estimated cyanobacteria biovolumes [@usepa2009national;@homer2004development;@xian2009updating;@hollister2010volume;@hollister_predicting_2011;@lakemorpho2014;@beaulieu2013nutrients].  All datasets are national in scale and provide a unique snapshot view of the condition of lakes in the United States' during the summer of 2007.

The NLA data were collected during the summer of 2007 and the final data were released in 2009.  With consistent methods and metrics collected at 1056 locations across the conterminous United States (Figure \ref{fig:nlaMap}), the NLA provides a unique opportunity to examine broad scale patterns in lake productivity.  The NLA collected data on biophysical measures of lake water quality and habitat.  For this analysis we primarily examined the water quality measurements from the NLA [@usepa2009national].  

Adding to the monitoring data collected via the NLA, we use the 2006 NLCD data to examine landscape-level drivers of trophic status in lakes.  The NLCD is a nationally collected land use land cover dataset that also provides estimates of impervious surface.  We calculated total proportion of each NLCD land use land cover class and total percent impervious surface within a 3 kilometer buffer surrounding the lake [@homer2004development;@xian2009updating]. 

To account for unique aspects of each lake and characterize lake productivity, we also used various measures of lake morphometry (i.e. depth, volume, fetch, etc.).  As these data are difficult to obtain for large numbers of lakes over broad regions, we used modeled estimates of lake morphometry [@hollister2010volume;@hollister_predicting_2011;@lakemorpho2014]. From these prior efforts we inlcuded, Surface Area, Shoreline Length, Shoreline Development, Maximum Depth, Mean Depth, Lake Volume, Maximum Lake Length, Mean Lake Width, Maximum Lake Width, and Fetch. 

Lastly, to explore associations between trophic state and cyanobacteria, we used estimates of cyanobacterial biovolume caluclated by Beaulieu *et al.* [-@beaulieu2013nutrients].  Cyanobacteria biovolumes are a truer measure of cyanobacteria dominance than abundance as there is great variability in cell size within and between species.  We have consolidated the taxa level estimates from Beaulieu *et al.* [-@beaulieu2013nutrients] and summed that information on a per-lake basis.

##Predicting Trophic State with Random Forests
Random forest is a machine learning algorithm that aggregates numerous decision trees in order to obtain a consensus prediction of the response categories [@breiman2001random].  Bootstrapped sample data is recursively partitioned according to a given random subset of predictor variables and completely grown without pruning.   With each new tree, both the sample data and predictor variable subset is randomly selected.  

While random forests are able to handle numerous correlated variables without a decrease in prediction accuracy, one possible downfall to this approach is that the resulting model may be difficult to interpret.  This is a problem often faced in gene selection and in that field, a variable selection method based on random forest has been succesfully applied [@diaz2006gene].  With this method, a minimum set of variables that maximizes model accuracy is provided.  This allows us to start with a full suite of predictor variables from which to select a minimum, more interpretable set of variables.  One issue with the approach in `varSelRF` is that becuase of the randomization inherent in random forests it is possible to get variation in the minimum selected set of variables.  To account for this we repeated `varSelRF` 100 times.  In our case, repeating the procedure 100 times quickly converged on a set of all possible important variables.  

##Model Details
Using both `varSelRF` and `randomForest` we ran models for six sets of variables and trophic state classifications.  These included three different combinations of the Chlorphyll *a* trophic states (Table \ref{tab:trophicStateTable}) as the dependent variables and using all variables or the GIS only variables (i.e. no *in situ* infromation) as the independt variables in the random forest.  The six model combinations were:


- **Model 1:** Chlorophyll *a* trophic state - 4 class = All variables (*in situ* water quality, lake morphometry, and landscape)
- **Model 2:** Chlorophyll *a* trophic state - 3 class = All variables (*in situ* water quality, lake morphometry, and landscape)
- **Model 3:** Chlorophyll *a* trophic state - 2 class = All variables (*in situ* water quality, lake morphometry, and landscape)
- **Model 4:** Chlorophyll *a* trophic state - 4 class = All variables (lake morphometry, and landscape)
- **Model 5:** Chlorophyll *a* trophic state - 3 class = All variables (lake morphometry, and landscape)
- **Model 6:** Chlorophyll *a* trophic state - 2 class = All variables (lake morphometry, and landscape)

Our modelling work flow was as follows:

1. Use `iterVarSelRF` in the `LakeTrophicModelling` R package to identify a minimal set of variables that maximize accuracy of the random forest algorithm [@diaz-uriarte2010varSelRF; @LakeTrophicModelling]. This subset of variables, the reduced model, is calculated for each of our 6 models. 
2. Using R's `randomForest` package, we pass the reduced models selected with `iterVarSelRF` and calculate confusion matrices, overall accuracy and kappa coeffecients for all 6 models [@liaw2002randomForest]. 

#Results and Discussion

Our complete dataset includes data on `r dim(ltmData)[1]` lakes; however `r sum(is.na(ltmData$TS_CHLA_4))` lakes did not have chlorophyll *a* data. Thus, the base dataset for our modelling was conducted on data for `r dim(ltmData[!is.na(ltmData$TS_CHLA_4),])[1]` lakes.  The lakes were well distributed both across the four trophic state categories (Table \ref{tab:trophicStateTable}) and spatially throughought the United States (Figure \ref{fig:nlaMap}).  

##Models
Accuracy for the models built with all predictors ranged from `r round(min(acc_results[1:3,2]),3)` to `r round(max(acc_results[1:3,2]),3)` and the kappa coeffecient had a minimum value of `r round(min(acc_results[1:3,3]),3)` and maximum of `r round(max(acc_results[1:3,3]),3)`.  The GIS only models had a total accuracy between `r round(min(acc_results[4:6,2]),3)` and `r round(min(acc_results[4:6,2]),3)` and kappa coeffecient between `r round(min(acc_results[4:6,3]),3)` and `r round(min(acc_results[4:6,3]),3)`.  The importance of variables for the models including the *in situ* data was fairly stable while There was considerably more variation in variable importance for the three different GIS only models.  Details for each model are discussed below.

###Model 1: 4 Trophic States ~ All Variables
The reduced model for Model 1 included potassium, nitrogen:phosphorus, total nitrogen, total phosphorus, total organic carbon, turbidity, ecoregion, organic ions, dissolved organic carbon, and maximum depth (Table \ref{tab:VarSel_Model1}) and of these, turbidity, total phosphorus, total nitrogen, and total organic carbon were the most four most important predictors of the four classes of trophic state (Figure \ref{fig:Importance_Model1}). Total accuracy for Model 1 was `r round(classAgreement(all_ts4_rf$confusion[,1:4])$diag,3)`% and the Cohen's Kappa was `r round(classAgreement(all_ts4_rf$confusion[,1:4])$kappa,3)` (Table \ref{tab:Confusion_Model1}).  

###Model 2: 3 Trophic States ~ All Variables
For Model 2, the reduced model included turbidity, total phosphorus, total nitrogen, total organic carbon, nitrogen:phophorus, longitude, pH, estimated organic anions, elevation, maximum depth, dissolved organic carbon, potassium, latitude, ecoregion, chloride, ammonium and percent cropland (Table \ref{tab:VarSel_Model2}). The top predictors for 3 trophic state classes were turbidity, total phosphorus, total nitrogen, and total organic carbon (Figure \ref{fig:Importance_Model2}).  Model 2 accuracy was `r round(classAgreement(all_ts3_rf$confusion[,1:4])$diag,3)`% and the Cohen's Kappa was `r round(classAgreement(all_ts3_rf$confusion[,1:4])$kappa,3)` (Table \ref{tab:Confusion_Model2}).   

###Model 3: 2 Trophic States ~ All Variables
The reduced model for Model 3 was similar to Model 1 and Model 2 and included turbidity, total phosphorus, total nitrogen, nitrogen:phophorus, potassium, ecoregion, elevation, total organic carbon, growing degree days, longitude, sodium, maximum depth, estimated organic anions, latitude, and dissolved organic carbon (Table \ref{tab:VarSel_Model3}). The top three predcitors were the same for Model 3; however, elevation and growing degree days had a higher importance than total organic carbon. (Figure \ref{fig:Importance_Model3}).  Total accuracy for Model 3 was `r round(classAgreement(all_ts2_rf$confusion[,1:2])$diag,3)`% and the Cohen's Kappa was `r round(classAgreement(all_ts2_rf$confusion[,1:2])$kappa,3)` (Table \ref{tab:Confusion_Model3}).

###Model 4: 4 Trophic States ~ GIS Only Variables
The selected variables for the Model 4 were longitude, latitude, elevation, estimated mean lake depth, percent evergreen forest, estimated maximum lake depth, percent cropland, and ecoregion (Table \ref{tab:VarSel_Model4}).  The most important variables were percent evergreen forest, ecoregion, percent cropland, and longitude (Figure \ref{fig:Importance_Model4}). Total accuracy for Model 4 is `r round(classAgreement(gis_ts4_rf$confusion[,1:4])$diag,3)`% and the Cohen's Kappa is `r round(classAgreement(gis_ts4_rf$confusion[,1:4])$kappa,3)` (Table \ref{tab:Confusion_Model4}).

###Model 5: 3 Trophic States ~ GIS Only Variables
The reduced model for Model 5 included estimated mean lake depth, percent cropland, longitude, latitude, percent evergreen forest, elevation, estimated maximum lake depth, estimated lake volume, percent decidous forest, percent developed open space, ecoregion, percent woody wetland, and percent shrub/scrub (Table \ref{tab:VarSel_Model5}). The most important variables for model 5 were ecoregion, perent evergreen forest, percent cropland, and estimated mean depth. (Figure \ref{fig:Importance_Model5}). Total accuracy for Model 5 is `r round(classAgreement(gis_ts3_rf$confusion[,1:3])$diag,3)`% and the Cohen's Kappa is `r round(classAgreement(gis_ts3_rf$confusion[,1:3])$kappa,3)` (Table \ref{tab:Confusion_Model5}).

###Model 6: 2 Trophic States ~ GIS Only Variables
The variable selection process for Model 6 produced a reduced model with ecoregion, growing degree days, percent evergreen forest, percent cropland, elevation, estimated mean lake depth, longitude, latitude, watershed area, estimated maximum lake depth, percent developed open space, percent decidous forest, and estimated lake volume (Table \ref{tab:VarSel_Model6}). Similar to models 4 and 5, the four most important variables were ecoregion, percent evergreen forest, percent cropland, and elevation (Figure \ref{fig:Importance_Model6}).  Total accuracy for Model 6 `r round(classAgreement(gis_ts2_rf$confusion[,1:2])$diag,3)`% and the Cohen's Kappa is `r round(classAgreement(gis_ts2_rf$confusion[,1:2])$kappa,3)` (Table \ref{tab:Confusion_Model6}).

##Trophic State Probabilities
<!--BRYAN EDIT/ADD IN THIS SECTION-->
One of the powerful features of random forests is that you utilize a very large number of competing models or trees.  Each tree provides an independent prediction or vote for a possible outcome.  In the context of our trophic state models, we have 10,000 votes for each lake.  These values may be interepreted as the probability that a lake is in a given trophic state. For instance, for a single lake (COMID = 23491387), the vote results for Model 1 ranged from round(min(lakeVotes[,4:7][lakeVotes$COMID==23491387,]),2) to round(max(lakeVotes[,4:7][lakeVotes$COMID==23491387,]),2) (Table \ref{tab:voteTable}).  

###Model Accuracy and Uncertainity
Further, the maximum probability for each lake can be used as a measure of how certain the random forest model was of the prediction.  We would expect higher total accuracy for lakes that had more certain predictions.  

To test this we can examine the accuracy of trophic state predictions across the full range of trophic state probabilities, similar to an approach outlined by Paul and MacDonald [-@paul2005development] and implemented by Hollister *et al.* [-@hollister2008cprob].  We utilize this approach and examine the change in total accuracy as a function of the maximum probability for each lake.  As expected, lakes with higher maximum vote probabilites are more accurately predicted (Figure \ref{fig:condProbFig}).  This suggest that even for models with low overall accuracy there will also be a large number of cases that are predicted with high accuarcy.

###Mapping Trophic State Probabilities 
In addition to exploring how model accuracy changes with the uncertainty of trophic state predicitions, the model votes may also be used to map the probability of lakes falling in a certain trophic state category.  In Figure \ref{fig:tsProbMap} we map the probability that lakes are classified as eutrophic/hypereutrophic with Model 3 and Model 6.   

##Associating Trophic State and Cyanobacteria

Cyanobacteria should be closely related to trophic state as they make up a component of the chlorophyll concentration in a lake. These associations have been seen by others ADD ALAN'S WORK and LESTERs Stuff

If these associations are strong enough we may be able to expand models such as those reported here to also predict probability of cyanobacteria blooms.  To test if trophic state may be used to differentiate cyanobacteria biovolume we examine distribution of cyanobacteria biovolume for each trophic state and we also explore linear associations between Chlorohyll *a* and cyanobacteria abundance.

(Figure \ref{fig:ts_4_cyano_cdf})

(Figure \ref{fig:ts_3_cyano_cdf})

(Figure \ref{fig:ts_2_cyano_cdf})

(Figure \ref{fig:scatterplot})

##Conclusions

The goals of this research were to explore the utility of a widely used data mining algorithm, random forests, in the modelling of lake trophic state. Further, we hoped to examine the utility of these random forest models when predicting trophic state with only ubiquitous GIS data.  This would allow for makeing trophic state estimates for all lakes in the United States.  

- were able to accurately predict TS classes
- more importantly have probabilities of TS
- RF will be useful for cyano probability plus many otehr enviro applications
- Also has utility for informing other approaches, i.e. Bayesian Network Models, can serve as priors.

\newpage

#Figures

```{r figSetup,echo=FALSE,eval=TRUE,cache=FALSE}
#create list of all selected variables and assign a color
vars<-ls(pattern="_vars")
all_vars<-vector()
for(i in vars){
  all_vars<-c(all_vars,get(i))
}
all_vars<-unique(all_vars)

all_movies_palette<-vector()
for(i in 1:dim(namelist)[1]){
  all_movies_palette<-c(all_movies_palette,wes.palette(namelist[i,2],
                                                       namelist[i,1]))
}
all_movies_palette<-unique(all_movies_palette)
zissou<-c(wes.palette(5,"Zissou"),wes.palette(5,"Zissou2"))
col_lu<-data.frame(variables=all_vars,hexcode=sample(all_movies_palette,length(all_vars)))
```


```{r nlaMap, echo=FALSE, fig.cap="Map of the distribution of National Lakes Assesment Sampling locations\\label{fig:nlaMap}",cache=FALSE}
state<-map_data('state')
lakes_alb<-data.frame(ltmData[["AlbersX"]],ltmData[["AlbersY"]])
p4s<-"+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"
ll<-"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
lakes_alb_sp<-SpatialPoints(coordinates(lakes_alb),proj4string=CRS(p4s))
lakes_dd<-spTransform(lakes_alb_sp,CRS=CRS(ll))
lakes_dd<-data.frame(coordinates(lakes_dd))
mycolor<-wes.palette(5,"Zissou2")
mycolor<-c(mycolor[1],mycolor[2],mycolor[4])
names(lakes_dd)<-c("long","lat",c())
nlaMap(state,lakes_dd,mycolor)
```

\newpage

```{r Importance_Model1,results="asis",echo=FALSE, fig.cap="Importance plot for Model 1\\label{fig:Importance_Model1}",cache=FALSE}
all_ts4_color<-col_lu[["hexcode"]][col_lu[["variables"]]%in%all_ts4_vars]
importancePlot(all_ts4_rf,'gini',size=5,aes(colour=all_ts4_color))
```

\newpage

```{r Importance_Model2,results="asis",echo=FALSE, fig.cap="Importance plot for Model 2\\label{fig:Importance_Model2}",cache=FALSE}
all_ts3_color<-col_lu[["hexcode"]][col_lu[["variables"]]%in%all_ts3_vars]
importancePlot(all_ts3_rf,'gini',size=5,aes(colour=all_ts3_color))
```

\newpage

```{r Importance_Model3,results="asis",echo=FALSE, fig.cap="Importance plot for Model 3\\label{fig:Importance_Model3}",cache=FALSE}
all_ts2_color<-col_lu[["hexcode"]][col_lu[["variables"]]%in%all_ts2_vars]
importancePlot(all_ts2_rf,'gini',size=5,aes(colour=all_ts2_color))
```

\newpage

```{r Importance_Model4,results="asis",echo=FALSE, fig.cap="Importance plot for Model 4\\label{fig:Importance_Model4}",cache=FALSE}
gis_ts4_color<-col_lu[["hexcode"]][col_lu[["variables"]]%in%gis_ts4_vars]
importancePlot(gis_ts4_rf,'gini',size=5,aes(colour=gis_ts4_color))
```

\newpage

```{r Importance_Model5,results="asis",echo=FALSE, fig.cap="Importance plot for Model 5\\label{fig:Importance_Model5}",cache=FALSE}
gis_ts3_color<-col_lu[["hexcode"]][col_lu[["variables"]]%in%gis_ts3_vars]
importancePlot(gis_ts3_rf,'gini',size=5,aes(colour=gis_ts3_color))
```

\newpage

```{r Importance_Model6,results="asis",echo=FALSE, fig.cap="Importance plot for Model 6\\label{fig:Importance_Model6}",cache=FALSE}
gis_ts2_color<-col_lu[["hexcode"]][col_lu[["variables"]]%in%gis_ts2_vars]
importancePlot(gis_ts2_rf,'gini',size=5,aes(colour=gis_ts2_color))
```

\newpage

```{r ts_4_cyano_cdf, echo=FALSE, fig.width=7, fig.cap="Cumulative distribution function of cyanobacetria abundance for 4 trophic state classes\\label{fig:ts_4_cyano_cdf}",cache=FALSE}
plotCdf(ltmData$TS_CHLA_4,ltmData$cyanoCellsPerML+1,cdf_colors=zissou[6:9],
        y='Percent',x='Log10(Cyanobacteria Abundance)',
        title=expression(paste('CDF for Chlorophyll ', 
                                italic("a"),' Trophic States (4 Categories)')),
        color="Trophic State\nCategories")
```

\newpage

```{r ts_3_cyano_cdf, echo=FALSE, fig.width=7, fig.cap="Cumulative distribution function of cyanobacetria abundance for 3 trophic state classes\\label{fig:ts_3_cyano_cdf}",cache=FALSE }
plotCdf(ltmData$TS_CHLA_3,ltmData$cyanoCellsPerML+1,cdf_colors=zissou[6:8],
       y='Percent',x='Log10(Cyanobacteria Abundance)', 
       title=expression(paste('CDF for Chlorophyll ', 
                              italic("a"),' Trophic States (3 Categories)')),
       color="Trophic State\nCategories")
```

\newpage

```{r ts_2_cyano_cdf, echo=FALSE, fig.width=7, fig.cap="Cumulative distribution function of cyanobacetria abundance for 2 trophic state classes\\label{fig:ts_2_cyano_cdf}",cache=FALSE}
plotCdf(ltmData$TS_CHLA_2,ltmData$cyanoCellsPerML+1,cdf_colors=zissou[6:7],
       y='Percent',x='Log10(Cyanobacteria Abundance)',
       title=expression(paste('CDF for Chlorophyll ', 
                              italic("a"),' Trophic States (2 Categories)')),
       color="Trophic State\nCategories")
```

\newpage

```{r scatterplot,echo=FALSE, fig.width=7, fig.cap="Cholorphyll *a* and cyanobacteria abundance scatterplot\\label{fig:scatterplot}",cache=FALSE}
scp_df<-data.frame(chla=ltmData[["CHLA"]],abundp1=ltmData[["cyanoCellsPerML"]]+1)
scatterPlot(scp_df,xvar="chla",yvar="abundp1",zissou[8],zissou[7],zissou[6],
             title=expression(paste("Chlorophyll ", 
                                    italic("a")," and Cyanobacteria Relationship")),
             x=expression(paste('Log10(Chl ', italic("a"),')')),
             y="Log10(Cyanobaterial Abundance + 1)")
```

\newpage

```{r condProbFig,echo=FALSE, fig.width=7, fig.cap="Comparison of certainity of trophic state prediction and total accuracy\\label{fig:condProbFig}",cache=FALSE}
condAccuracy(gis_ts4_rf,xImpair=0,R=1,xlab="Maximum Vote Probability")
```

\newpage

```{r tsProbMap,echo=FALSE, fig.width=7, fig.cap="Map of the probability of lakes being eutrophic or hypereutrophic\\label{fig:tsProbMap}",cache=FALSE}

```

\newpage

#Tables

```{r trophicStateTable, results='asis', echo=FALSE, tab.cap="Chlorophyll a based trophic state cut-offs\\label{tab:trophicStateTable}",cache=FALSE}
ts_4<-c("oligo","meso","eu","hyper")
ts_3<-c("oligo","meso/eu","meso/eu","hyper")
ts_2<-c("oligo/meso","oligo/meso","eu/hyper","eu/hyper")
co<-c("<= 0.2",">2-7",">7-30",">30")
xdf<-data.frame(ts_4,ts_3,ts_2,co,as.vector(table(ltmData$TS_CHLA_4)))
names(xdf)<-c("Trophic State (4)","Trophic State (3)","Trophic State (2)","Cut-off","n")
kable(xdf)
```

\newpage

```{r VarSel_Model1,results="asis",echo=FALSE, tab.cap="Variable selection results for Model 1\\label{tab:VarSel_Model1}",cache=FALSE}
kable(sumTable(all_ts4[1:100]),row.names=F)
```

\newpage

```{r Confusion_Model1,results="asis",echo=FALSE, tab.cap="Random Forest confusion matrix for Model 1\\label{tab:Confusion_Model1}",cache=FALSE}
kable(formatC(round(all_ts4_rf$confusion,2)),row.names=F)
```

\newpage

```{r VarSel_Model2,results="asis",echo=FALSE, tab.cap="Variable selection results for Model 2\\label{tab:VarSel_Model2}",cache=FALSE}
kable(sumTable(all_ts3[1:100]),row.names=F)
```

\newpage

```{r Confusion_Model2,results="asis",echo=FALSE, tab.cap="Random Forest confusion matrix for Model 2\\label{tab:Confusion_Model2}",cache=FALSE}
kable(formatC(round(all_ts3_rf$confusion,2)),row.names=F)
```

\newpage

```{r VarSel_Model3,results="asis",echo=FALSE, tab.cap="Variable selection results for Model 3\\label{tab:VarSel_Model3}",cache=FALSE}
kable(sumTable(all_ts2[1:100]),row.names=F)
```

\newpage

```{r Confusion_Model3,results="asis",echo=FALSE, tab.cap="Random Forest confusion matrix for Model 3\\label{tab:Confusion_Model3}",cache=FALSE}
kable(formatC(round(all_ts2_rf$confusion,2)),row.names=F)
```

\newpage

```{r VarSel_Model4,results="asis",echo=FALSE, tab.cap="Variable selection results for Model 4\\label{tab:VarSel_Model4}",cache=FALSE }
kable(sumTable(gis_ts4[1:100]),row.names=F)
```

\newpage

```{r Confusion_Model4,results="asis",echo=FALSE, tab.cap="Random Forest confusion matrix for Model 4\\label{tab:Confusion_Model4}",cache=FALSE }
kable(formatC(round(gis_ts4_rf$confusion,2)),row.names=F)
```

\newpage

```{r VarSel_Model5,results="asis",echo=FALSE, tab.cap="Variable selection results for Model 5\\label{tab:VarSel_Model5}",cache=FALSE}
kable(sumTable(gis_ts3[1:100]),row.names=F)
```

\newpage

```{r Conufsion_Model5,results="asis",echo=FALSE, tab.cap="Random Forest confusion matrix for Model 5\\label{tab:Confusion_Model5}",cache=FALSE}
kable(formatC(round(gis_ts3_rf$confusion,2)),row.names=F)
```

\newpage

```{r VarSel_Model6,results="asis",echo=FALSE, tab.cap="Variable selection results for Model 6\\label{tab:VarSel_Model6}",cache=FALSE}
kable(sumTable(gis_ts2[1:100]),row.names=F)
```

\newpage

```{r Confusion_Model6,results="asis",echo=FALSE, tab.cap="Random forest confusion matrix for Model 6\\label{tab:Confusion_Model6}",cache=FALSE}
kable(formatC(round(gis_ts2_rf$confusion,2)),row.names=F)
```

\newpage

```{r voteTable, results="asis",echo=FALSE, tab.cap="Example Lake Random Forest Vote Results\\label{tab:voteTable}",cache=FALSE}
kable(lakeVotes[,4:7][lakeVotes$COMID==23491387,],row.names=F)
```

#References